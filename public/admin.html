<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG Virtual Line - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="icon" href="data:," />
  <style>.card{box-shadow:0 2px 12px rgba(0,0,0,.08)}</style>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="max-w-3xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between py-4">
      <div>
        <h1 class="text-xl font-bold">MG Virtual Line</h1>
        <p class="text-xs text-slate-500">Admin</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/history.html" class="text-sm text-slate-500 hover:text-slate-300">History</a>
        <span id="meEmail" class="text-xs text-slate-600"></span>
        <button id="logoutBtn" class="text-sm text-slate-600 hover:text-slate-800">Logout</button>
      </div>
    </header>

    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
        <div>
          <input id="adminVendorName" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="Shop/Office Name" />
          <div id="nameWarn" class="text-xs text-rose-400 mt-1 hidden">Name already exists. Choose a unique name.</div>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button id="createVendorBtn" class="py-2 px-4 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Create New Vendor</button>
          <select id="vendorSwitch" class="border border-slate-700 bg-slate-900 rounded px-4 py-2 text-sm w-full md:w-auto"></select>
        </div>
      </div>
      <div id="vendorInfo" class="mt-3 hidden">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-400">Vendor Code</div>
            <div id="vendorCodeLabel" class="text-xl font-bold">-</div>
          </div>
          <div class="flex gap-2">
            <button id="nextBtn" class="py-2 px-4 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Next Token</button>
            <button id="clearBtn" class="py-2 px-4 rounded bg-amber-600 hover:bg-amber-500 text-white">Clear Queue</button>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-3 gap-3 text-center">
          <div class="p-3 rounded bg-slate-800 border border-slate-700"><div class="text-xs text-slate-400">Serving</div><div id="adminServing" class="text-2xl font-bold">-</div></div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700"><div class="text-xs text-slate-400">Last Issued</div><div id="adminLastIssued" class="text-2xl font-bold">-</div></div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700"><div class="text-xs text-slate-400">Next Waiting</div><div id="adminNextWaiting" class="text-2xl font-bold">-</div></div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <div class="text-sm text-slate-400 mb-1">Public QR</div>
            <img id="qrImg" class="border border-slate-700 rounded max-h-48 bg-slate-900" />
          </div>
          <div>
            <div class="text-sm text-slate-400 mb-1">Token List</div>
            <div id="tokenList" class="border border-slate-700 rounded p-2 h-64 overflow-auto text-sm bg-slate-900"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const socket = io();
    let joinedVendor = null;

    async function apiJson(url, options = {}) {
      const res = await fetch(url, options);
      const text = await res.text();
      try { const data = JSON.parse(text); if (!res.ok) throw new Error(data.error || res.statusText); return data; } catch (e) { throw new Error(text); }
    }

    (async () => {
      const me = await apiJson('/auth/me');
      if (!me.user || me.user.role !== 'admin') { location.href = '/'; return; }
      $('meEmail').textContent = me.user.email || '';
      // Load vendor list for switcher
      try {
        const lm = await apiJson('/vendor/listMine');
        const sel = $('vendorSwitch');
        sel.innerHTML = '<option value="">Switch Vendor…</option>' + (lm.vendors||[]).map(v => `<option value="${v.vendorCode}">${v.name} (${v.vendorCode})</option>`).join('');
        window.__vendorNames = new Set((lm.vendors||[]).map(v => (v.name||'').trim().toLowerCase()));
        async function checkNameUnique(){
          const nRaw = ($('adminVendorName').value||'').trim();
          const n = nRaw.toLowerCase();
          let exists = n && window.__vendorNames && window.__vendorNames.has(n);
          if (!exists && n) {
            try {
              const r = await apiJson(`/vendor/checkName?name=${encodeURIComponent(nRaw)}`);
              exists = !r.available;
            } catch(_) {}
          }
          $('createVendorBtn').disabled = !!exists;
          $('createVendorBtn').style.opacity = exists ? '0.6' : '1';
          $('createVendorBtn').style.cursor = exists ? 'not-allowed' : 'pointer';
          const warn = $('nameWarn'); if (exists) warn.classList.remove('hidden'); else warn.classList.add('hidden');
        }
        $('adminVendorName').addEventListener('input', checkNameUnique);
        checkNameUnique();
        sel.addEventListener('change', () => {
          const code = sel.value;
          if (!code) return;
          localStorage.setItem('admin_vendor_code', code);
          $('vendorInfo').classList.remove('hidden');
          $('vendorCodeLabel').textContent = code;
          joinVendorRoom(code);
          refreshTokenList(code);
          (async () => { try { const q = await apiJson(`/vendor/qr?vendorCode=${encodeURIComponent(code)}`); $('qrImg').src = q.qrDataUrl; } catch(_){} })();
        });
      } catch(_) {}
      // Prefer server-saved vendor for this admin
      try {
        const vm = await apiJson('/vendor/mine');
        if (vm.vendor) {
          $('vendorInfo').classList.remove('hidden');
          $('vendorCodeLabel').textContent = vm.vendor.vendorCode;
          $('adminVendorName').value = vm.vendor.name || '';
          joinVendorRoom(vm.vendor.vendorCode);
          refreshTokenList(vm.vendor.vendorCode);
          localStorage.setItem('admin_vendor_code', vm.vendor.vendorCode);
          // restore QR
          try {
            const q = await apiJson(`/vendor/qr?vendorCode=${encodeURIComponent(vm.vendor.vendorCode)}`);
            $('qrImg').src = q.qrDataUrl;
          } catch(_){}
          return;
        }
      } catch (_) {}
      // Fallback to local storage
      const savedVendor = localStorage.getItem('admin_vendor_code');
      if (savedVendor) {
        $('vendorInfo').classList.remove('hidden');
        $('vendorCodeLabel').textContent = savedVendor;
        joinVendorRoom(savedVendor);
        refreshTokenList(savedVendor);
        try {
          const q = await apiJson(`/vendor/qr?vendorCode=${encodeURIComponent(savedVendor)}`);
          $('qrImg').src = q.qrDataUrl;
        } catch(_){}
      }
    })();

    function joinVendorRoom(vendorCode) {
      if (!vendorCode || vendorCode === joinedVendor) return;
      joinedVendor = vendorCode;
      socket.emit('join_vendor', vendorCode);
    }

    $('createVendorBtn').addEventListener('click', async () => {
      const nameInput = $('adminVendorName').value.trim();
      const name = nameInput || prompt('New Vendor Name?') || 'My Shop';
      const res = await fetch('/vendor/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      $('vendorInfo').classList.remove('hidden');
      $('vendorCodeLabel').textContent = data.vendor.vendorCode;
      $('qrImg').src = data.qrDataUrl;
      joinVendorRoom(data.vendor.vendorCode);
      refreshTokenList(data.vendor.vendorCode);
      // Persist selection for refresh
      localStorage.setItem('admin_vendor_code', data.vendor.vendorCode);
      // Update switcher
      try {
        const lm = await apiJson('/vendor/listMine');
        $('vendorSwitch').innerHTML = '<option value="">Switch Vendor…</option>' + (lm.vendors||[]).map(v => `<option value="${v.vendorCode}">${v.name} (${v.vendorCode})</option>`).join('');
        window.__vendorNames = new Set((lm.vendors||[]).map(v => (v.name||'').trim().toLowerCase()));
      } catch(_){}
    });

    $('nextBtn').addEventListener('click', async () => {
      const vendorCode = $('vendorCodeLabel').textContent.trim();
      if (!vendorCode) return;
      const res = await fetch('/token/next', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vendorCode }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      const msg = `Token ${data.served ?? ''} created. ${data.vendor?.currentServing ? `Now serving ${data.vendor.currentServing}.` : ''}`.trim();
      if (msg) console.log(msg);
      refreshTokenList(vendorCode);
    });

    $('clearBtn').addEventListener('click', async () => {
      const vendorCode = $('vendorCodeLabel').textContent.trim();
      if (!vendorCode) return;
      if (!confirm('Clear Queue: delete all tokens and reset counters?')) return;
      const res = await fetch('/vendor/clear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vendorCode }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      refreshTokenList(vendorCode);
    });

    $('newShopBtn').addEventListener('click', async () => {
      // Create a fresh shop. Old history remains in DB and is not editable
      const nameInput = $('adminVendorName').value.trim();
      const name = nameInput || prompt('New Shop Name? (leave blank to use previous)') || (nameInput || 'My Shop');
      const res = await fetch('/vendor/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      $('vendorInfo').classList.remove('hidden');
      $('vendorCodeLabel').textContent = data.vendor.vendorCode;
      $('adminVendorName').value = data.vendor.name || '';
      $('qrImg').src = data.qrDataUrl;
      joinVendorRoom(data.vendor.vendorCode);
      refreshTokenList(data.vendor.vendorCode);
      localStorage.setItem('admin_vendor_code', data.vendor.vendorCode);
    });

    async function refreshTokenList(vendorCode) {
      const [tokensRes, histRes] = await Promise.all([
        fetch(`/token/list?vendorCode=${encodeURIComponent(vendorCode)}`),
        fetch(`/history/list`)
      ]);
      const data = await tokensRes.json();
      if (data.error) return;
      const histData = await histRes.json();
      const historyByTokenId = new Map((histData.records || []).map(r => [String(r.tokenId), r]));
      const labelFromHistory = (rec, token) => {
        if (rec && rec.status) return rec.status; // Created/Completed
        return token.status === 'waiting' ? 'Pending' : (token.status === 'served' ? 'Created' : token.status);
      };
      const rows = (data.tokens || []).map(t => {
        const rec = historyByTokenId.get(String(t._id));
        const statusLabel = labelFromHistory(rec, t);
        const badge = statusLabel === 'Created' ? 'bg-amber-600' : (statusLabel === 'Pending' ? 'bg-slate-600' : 'bg-emerald-600');
        const canAdminConfirm = !!rec && rec.status !== 'Completed' && !rec.adminConfirmed;
        const actions = canAdminConfirm ? `<button class=\"text-xs px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white admin-confirm\" data-id=\"${t._id}\">Confirm</button>` : '';
        return `<tr class=\"border-b border-slate-800\"><td class=\"py-1 pr-3\">#${t.number}</td><td class=\"py-1 pr-3\"><span class=\"px-2 py-1 rounded text-xs ${badge}\">${statusLabel}</span></td><td class=\"py-1 pr-3\">${actions}</td></tr>${t.note?`<tr class=\"border-b border-slate-800 text-xs text-slate-500\"><td colspan=\"3\">Note: ${t.note}</td></tr>`:''}`;
      }).join('');
      $('tokenList').innerHTML = rows ? `<table class=\"w-full text-sm\"><thead><tr class=\"text-left text-slate-400 border-b border-slate-700\"><th class=\"py-1 pr-3\">Token</th><th class=\"py-1 pr-3\">Status</th><th class=\"py-1 pr-3\">Actions</th></tr></thead><tbody>${rows}</tbody></table>` : '<div class="text-slate-400">No tokens yet</div>';
      // wire admin confirm buttons (exactly like history)
      $('tokenList').querySelectorAll('button.admin-confirm').forEach(btn => {
        btn.addEventListener('click', async () => {
          const tokenId = btn.getAttribute('data-id');
          try {
            await fetch('/history/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tokenId }) });
            await refreshTokenList(vendorCode);
          } catch (e) { alert('Confirm failed'); }
        });
      });
      $('adminServing').textContent = data.vendor?.currentServing ?? '-';
      $('adminLastIssued').textContent = data.vendor?.lastIssued ?? '-';
    }

    socket.on('vendor_update', (payload) => {
      if (!joinedVendor || payload.vendorCode !== joinedVendor) return;
      $('adminServing').textContent = payload.currentServing || '-';
      $('adminLastIssued').textContent = payload.lastIssued || '-';
      $('adminNextWaiting').textContent = payload.nextWaiting ?? '-';
      refreshTokenList(joinedVendor);
    });

    $('logoutBtn').addEventListener('click', async () => { 
      localStorage.removeItem('admin_vendor_code');
      await fetch('/auth/logout', { method: 'POST' }); 
      location.href = '/'; 
    });
  </script>
</body>
</html>


