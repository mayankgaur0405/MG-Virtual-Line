<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>MG Virtual Line - User</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link rel="icon" href="data:," />
  <style>
    .card{box-shadow:0 2px 12px rgba(0,0,0,.08)}
    
    /* Token Card Styles - Circular Design */
    .token-card {
      background: linear-gradient(145deg, #1e293b, #334155);
      border: 2px solid #475569;
      border-radius: 50%;
      width: 200px;
      height: 200px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 16px -4px rgba(0, 0, 0, 0.2),
        0 4px 8px -2px rgba(0, 0, 0, 0.1),
        inset 0 2px 4px rgba(255, 255, 255, 0.1),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
      margin: 0 auto;
    }
    
    .token-card::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
      opacity: 0.1;
      z-index: 1;
    }
    
    .token-card::after {
      content: '';
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      bottom: 12px;
      border-radius: 50%;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      z-index: 2;
    }
    
    .token-card:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 
        0 12px 24px -4px rgba(0, 0, 0, 0.3),
        0 8px 16px -4px rgba(0, 0, 0, 0.2),
        inset 0 2px 4px rgba(255, 255, 255, 0.2),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3);
      border-color: #64748b;
    }
    
    .token-card.animate-in {
      animation: tokenSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes tokenSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.8) rotate(-10deg);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1) rotate(0deg);
      }
    }
    
    .token-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      z-index: 3;
      position: relative;
      flex: 0 0 auto;
    }
    
    .token-name {
      font-size: 0.7rem;
      font-weight: 700;
      color: #f8fafc;
      letter-spacing: -0.025em;
      margin-bottom: 6px;
      text-align: center;
      line-height: 1.1;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 6px;
      word-break: break-word;
    }
    
    /* Clickable token styling */
    .token-card.clickable {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .token-card.clickable:hover {
      transform: translateY(-6px) scale(1.08);
      box-shadow: 
        0 16px 32px -8px rgba(0, 0, 0, 0.4),
        0 12px 24px -6px rgba(0, 0, 0, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.3),
        inset 0 -2px 4px rgba(0, 0, 0, 0.4);
    }
    
    .token-card.clickable::before {
      content: 'â‹¯';
      position: absolute;
      top: 8px;
      right: 8px;
      color: #94a3b8;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 4;
      opacity: 0.7;
    }
    
    .token-card.clickable:hover::before {
      opacity: 1;
      color: #f8fafc;
    }
    
    .token-id {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.75rem;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 3;
      position: relative;
      margin-bottom: 6px;
    }
    
    .token-vendor-code {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      margin-bottom: 6px;
      z-index: 3;
      position: relative;
    }
    
    .vendor-code-label {
      color: #94a3b8;
      font-size: 0.55rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .vendor-code-value {
      background: linear-gradient(135deg, #374151, #4b5563);
      color: #f8fafc;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.6rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.05em;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .token-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      margin-bottom: 8px;
      z-index: 3;
      position: relative;
      flex: 0 0 auto;
    }
    
    .status-label {
      color: #cbd5e1;
      font-size: 0.6rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .status-badge {
      padding: 3px 10px;
      border-radius: 14px;
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
      max-width: 90px;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    
    .status-badge.pending {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
      animation: pulse 2s infinite;
    }
    
    .status-badge.created {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .status-badge.completed {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }
    
    .token-actions {
      display: flex;
      justify-content: center;
      margin-top: 4px;
      z-index: 3;
      position: relative;
      flex: 0 0 auto;
    }
    
    .token-btn {
      padding: 4px 10px;
      border-radius: 14px;
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      max-width: 80px;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    
    .token-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .token-btn:hover::before {
      left: 100%;
    }
    
    .token-btn.confirm {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    
    .token-btn.confirm:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    
    .token-card.pending {
      animation: tokenGlow 3s ease-in-out infinite;
    }
    
    @keyframes tokenGlow {
      0%, 100% {
        box-shadow: 
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      50% {
        box-shadow: 
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          0 0 20px rgba(245, 158, 11, 0.1);
      }
    }
    
    .token-card.completed {
      opacity: 0.7;
      transform: scale(0.98);
    }
    
    .token-card.completed:hover {
      opacity: 1;
      transform: scale(1);
    }
    
    /* Additional visual enhancements */
    .token-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.02) 50%, transparent 70%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .token-card:hover::after {
      opacity: 1;
    }
    
    .token-card.pending::after {
      background: linear-gradient(45deg, transparent 30%, rgba(245, 158, 11, 0.1) 50%, transparent 70%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Status transition animations */
    .status-badge {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .status-badge.status-changing {
      animation: statusChange 0.6s ease-in-out;
    }
    
    @keyframes statusChange {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Token number highlight */
    .token-id {
      position: relative;
      overflow: hidden;
    }
    
    .token-id::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }
    
    .token-card:hover .token-id::before {
      left: 100%;
    }
    
    /* Loading state for buttons */
    .token-btn.loading {
      position: relative;
      color: transparent;
    }
    
    .token-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Token Details Modal */
    .token-details-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .token-details-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .token-details-content {
      background: linear-gradient(145deg, #1e293b, #334155);
      border: 2px solid #475569;
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      position: relative;
      box-shadow: 
        0 20px 40px -8px rgba(0, 0, 0, 0.5),
        0 8px 16px -4px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .token-details-modal.show .token-details-content {
      transform: scale(1);
    }
    
    .token-details-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .token-details-close:hover {
      color: #f8fafc;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .token-details-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 8px;
    }
    
    .token-details-id {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0 auto 16px;
      display: inline-block;
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }
    
    .token-details-status {
      margin-bottom: 20px;
    }
    
    .token-details-vendor-code {
      margin-bottom: 16px;
    }
    
    .token-details-status-label {
      color: #cbd5e1;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .token-details-status-badge {
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .token-details-status-badge.pending {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }
    
    .token-details-status-badge.created {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .token-details-status-badge.completed {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }
    
    .token-details-actions {
      margin-top: 20px;
    }
    
    .token-details-btn {
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }
    
    .token-details-btn:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-2px);
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .max-w-5xl { max-width: 100%; }
      .p-4 { padding: 1rem; }
      .gap-6 { gap: 1rem; }
      .text-xl { font-size: 1.125rem; }
      .text-2xl { font-size: 1.5rem; }
      .text-3xl { font-size: 1.875rem; }
      .py-3 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
      .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
      
      .token-card {
        width: 160px;
        height: 160px;
        padding: 18px;
      }
      
      .token-name {
        font-size: 0.65rem;
        max-width: 100px;
        margin-bottom: 4px;
      }
      
      .token-name.long-name {
        font-size: 0.6rem;
        max-width: 95px;
      }
      
      .token-id {
        font-size: 0.7rem;
        padding: 3px 10px;
        margin-bottom: 4px;
      }
      
      .vendor-code-label {
        font-size: 0.5rem;
      }
      
      .vendor-code-value {
        font-size: 0.55rem;
        padding: 2px 6px;
      }
      
      .status-label {
        font-size: 0.5rem;
      }
      
      .status-badge {
        font-size: 0.5rem;
        padding: 2px 8px;
        max-width: 75px;
      }
      
      .token-btn {
        font-size: 0.5rem;
        padding: 3px 8px;
        max-width: 65px;
      }
    }
    
    @media (max-width: 480px) {
      .token-card {
        width: 140px;
        height: 140px;
        padding: 14px;
      }
      
      .token-name {
        font-size: 0.6rem;
        max-width: 90px;
        margin-bottom: 3px;
      }
      
      .token-name.long-name {
        font-size: 0.55rem;
        max-width: 85px;
      }
      
      .token-id {
        font-size: 0.65rem;
        padding: 2px 8px;
        margin-bottom: 3px;
      }
      
      .vendor-code-label {
        font-size: 0.45rem;
      }
      
      .vendor-code-value {
        font-size: 0.5rem;
        padding: 1px 5px;
      }
      
      .status-label {
        font-size: 0.45rem;
      }
      
      .status-badge {
        font-size: 0.45rem;
        padding: 2px 6px;
        max-width: 65px;
      }
      
      .token-btn {
        font-size: 0.45rem;
        padding: 2px 6px;
        max-width: 55px;
      }
    }
    
    /* Prevent zoom on input focus */
    input, select, textarea { font-size: 16px; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="max-w-5xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between py-4">
      <div>
        <h1 class="text-xl font-bold">MG Virtual Line</h1>
        <p class="text-xs text-slate-400">User</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/history.html" class="text-sm text-slate-300 hover:text-white">History</a>
        <!-- Profile icon -->
        <div class="relative">
          <button id="profileBtn" class="w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white text-sm font-medium">
            <span id="profileInitial">U</span>
          </button>
          <!-- Profile dropdown -->
          <div id="profileDropdown" class="absolute right-0 top-full mt-2 w-64 bg-slate-800 border border-slate-700 rounded-lg shadow-lg hidden z-50">
            <div class="p-3 border-b border-slate-700">
              <div class="text-sm font-medium" id="profileEmail"></div>
              <div class="text-xs text-slate-400">User Account</div>
            </div>
            <div class="p-2">
              <button id="editProfileBtn" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 rounded">Edit Profile</button>
              <button id="logoutBtn" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 rounded">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-slate-300">Vendor Code</label>
          <input id="vendorInput" class="mt-1 w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="e.g. ABC123" />
          <div class="flex items-center gap-2 mt-2">
            <button id="scanQrBtn" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm border border-indigo-500/40">Scan QR</button>
            <p class="text-xs text-slate-400">Auto-filled from QR or link.</p>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300">Optional Request/Note</label>
          <input id="noteInput" class="mt-1 w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="Brief note" />
        </div>
        <button id="getTokenBtn" class="w-full py-3 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-lg font-semibold">Get Token</button>
      </div>
      <div id="userStatus" class="mt-4 hidden">
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Your Token</div>
            <div id="yourToken" class="text-2xl font-bold">-</div>
          </div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Serving</div>
            <div id="currentServing" class="text-2xl font-bold">-</div>
          </div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Est. Wait</div>
            <div id="eta" class="text-2xl font-bold">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Notifications Panel -->
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Notifications</h3>
        <button id="notifClear" class="text-xs px-2 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-800">Clear</button>
      </div>
      <div id="notifList" class="space-y-2 max-h-56 overflow-auto text-sm">
        <div class="text-slate-400">No notifications yet.</div>
      </div>
    </section>
    </div>

    <!-- Multi-shop cards -->
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Your Tokens</h3>
        <div class="text-xs text-slate-400">Auto-updating</div>
      </div>
      <div id="shopCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 justify-items-center"></div>
    </section>

    <!-- QR Scanner Modal -->
    <div id="qrModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4">
      <div class="bg-slate-800 border border-slate-700 rounded-lg w-full max-w-sm p-4 space-y-3 text-slate-100">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Scan QR Code</h3>
          <button id="qrCloseBtn" class="text-slate-400 hover:text-slate-200">Close</button>
        </div>
        <video id="qrVideo" class="w-full rounded border border-slate-700 bg-slate-950" playsinline></video>
        <p class="text-xs text-slate-400">Point your camera at the shop/office QR.</p>
      </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4">
      <div class="bg-slate-800 border border-slate-700 rounded-lg w-full max-w-sm p-4 space-y-3 text-slate-100">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Edit Profile</h3>
          <button id="profileCloseBtn" class="text-slate-400 hover:text-slate-200">Close</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
            <input id="profileName" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="Your name" />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1">Email</label>
            <input id="profileEmailInput" type="email" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="your@email.com" />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-1">Phone (Optional)</label>
            <input id="profilePhone" class="w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="+1234567890" />
          </div>
        </div>
        <div class="flex gap-2 pt-2">
          <button id="saveProfileBtn" class="flex-1 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white">Save</button>
          <button id="cancelProfileBtn" class="flex-1 py-2 rounded bg-slate-700 hover:bg-slate-600 text-white">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden max-w-xs bg-slate-800 border border-slate-700 text-slate-100 text-sm rounded px-3 py-2 shadow"></div>

  <!-- Token Details Modal -->
  <div id="tokenDetailsModal" class="token-details-modal">
    <div class="token-details-content">
      <button id="tokenDetailsClose" class="token-details-close">&times;</button>
      <div class="token-details-title" id="tokenDetailsTitle"></div>
      <div class="token-details-id" id="tokenDetailsId"></div>
      <div class="token-details-status">
        <div class="token-details-status-label">Status:</div>
        <div class="token-details-status-badge" id="tokenDetailsStatus"></div>
      </div>
      <div class="token-details-actions" id="tokenDetailsActions"></div>
    </div>
  </div>


  <script>
    const $ = (id) => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const vendorFromUrl = params.get('vendor');
    if (vendorFromUrl) $('vendorInput').value = vendorFromUrl;

    async function apiJson(url, options = {}) {
      const res = await fetch(url, options);
      const text = await res.text();
      try { const data = JSON.parse(text); if (!res.ok) throw new Error(data.error || res.statusText); return data; } catch (e) { throw new Error(text); }
    }

    // Global user data
    let currentUser = null;

    (async () => {
      const me = await apiJson('/auth/me');
      if (!me.user) { location.href = '/'; return; }
      if (me.user.role === 'admin') { location.href = '/admin.html'; return; }
      
      currentUser = me.user;
      
      // Update profile display
      $('profileEmail').textContent = me.user.email || '';
      $('profileInitial').textContent = (me.user.name || me.user.email || 'U').charAt(0).toUpperCase();
      
      // Prefer server latest token for this user/vendor if provided via URL or storage
      let vendor = vendorFromUrl || localStorage.getItem('user_vendor_code');
      if (vendor) {
        $('vendorInput').value = vendor;
        joinVendorRoom(vendor);
        refreshVendorStatus(vendor);
        try {
          const mine = await apiJson(`/token/mine?vendorCode=${encodeURIComponent(vendor)}`);
          if (mine.token) {
            myTokenNumber = mine.token.number;
            $('userStatus').classList.remove('hidden');
            $('yourToken').textContent = myTokenNumber;
            // restore vendor stats too
            $('currentServing').textContent = mine.vendor?.currentServing ?? '-';
            $('eta').textContent = estWait(mine.vendor?.currentServing, myTokenNumber);
            if (typeof mine.token.note === 'string') $('noteInput').value = mine.token.note;
            localStorage.setItem('user_token_number', String(myTokenNumber));
            localStorage.setItem('user_vendor_code', vendor);
            if (mine.token._id) localStorage.setItem('user_token_id', mine.token._id);
          } else {
            const savedId = localStorage.getItem('user_token_id');
            if (savedId) {
              const t = await apiJson(`/token/get?id=${encodeURIComponent(savedId)}`);
              if (t.token && t.token.vendorCode === vendor) {
                myTokenNumber = t.token.number;
                $('userStatus').classList.remove('hidden');
                $('yourToken').textContent = myTokenNumber;
                $('currentServing').textContent = t.vendor?.currentServing ?? '-';
                $('eta').textContent = estWait(t.vendor?.currentServing, myTokenNumber);
                if (typeof t.token.note === 'string') $('noteInput').value = t.token.note;
              }
            }
          }
        } catch (_) {}
      } else {
        // fallback to local only
        const savedVendor = localStorage.getItem('user_vendor_code');
        const savedToken = localStorage.getItem('user_token_number');
        const savedNote = localStorage.getItem('user_note');
        if (savedVendor) {
          $('vendorInput').value = savedVendor;
          joinVendorRoom(savedVendor);
          refreshVendorStatus(savedVendor);
        }
        if (savedToken) {
          document.getElementById('userStatus').classList.remove('hidden');
          document.getElementById('yourToken').textContent = savedToken;
          myTokenNumber = parseInt(savedToken, 10);
        }
        if (savedNote) $('noteInput').value = savedNote;
      }
      
      // Load initial shops and notifications, start auto-refresh
      loadMyShops();
      loadNotifications();
      setInterval(loadMyShops, 5000); // Auto-refresh every 5 seconds
    })();

    const socket = io();
    let joinedVendor = null;
    let myTokenNumber = null;
    let qrStream = null;
    let qrAnimating = false;

    // Notifications
    function addNotifCard(title, body, persistent = true, tokenId = null, tokenNumber = null, vendorCode = null) {
      const list = document.getElementById('notifList');
      const ts = new Date();
      const time = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const notification = {
        id: Date.now() + Math.random(),
        title,
        body,
        time: ts.toISOString(),
        persistent,
        tokenId,
        tokenNumber,
        vendorCode
      };
      
      // Add to localStorage if persistent
      if (persistent) {
        const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
        notifications.unshift(notification);
        // Keep only last 50 notifications
        if (notifications.length > 50) {
          notifications.splice(50);
        }
        localStorage.setItem('notifications', JSON.stringify(notifications));
      }
      
      // Add to UI
      const card = document.createElement('div');
      card.className = 'rounded border border-slate-700 p-2 bg-slate-900';
      card.setAttribute('data-notif-id', notification.id);
      card.innerHTML = `<div class="flex items-center justify-between"><div class="font-medium">${title}</div><div class="text-xs text-slate-400">${time}</div></div><div class="text-slate-300 text-sm mt-1">${body}</div>`;
      if (list.firstElementChild && list.firstElementChild.classList.contains('text-slate-400')) {
        list.innerHTML = '';
      }
      list.prepend(card);
    }
    
    function loadNotifications() {
      const list = document.getElementById('notifList');
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      
      if (notifications.length === 0) {
        list.innerHTML = '<div class="text-slate-400">No notifications yet.</div>';
        return;
      }
      
      list.innerHTML = '';
      notifications.forEach(notif => {
        const time = new Date(notif.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const card = document.createElement('div');
        card.className = 'rounded border border-slate-700 p-2 bg-slate-900';
        card.setAttribute('data-notif-id', notif.id);
        card.innerHTML = `<div class="flex items-center justify-between"><div class="font-medium">${notif.title}</div><div class="text-xs text-slate-400">${time}</div></div><div class="text-slate-300 text-sm mt-1">${notif.body}</div>`;
        list.appendChild(card);
      });
    }
    
    function clearCompletedNotifications() {
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      const filtered = notifications.filter(notif => 
        !notif.body.includes('has been confirmed') && 
        !notif.body.includes('is now being served')
      );
      localStorage.setItem('notifications', JSON.stringify(filtered));
      loadNotifications();
    }
    
    function clearNotificationsForToken(tokenId) {
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      const filtered = notifications.filter(notif => notif.tokenId !== tokenId);
      localStorage.setItem('notifications', JSON.stringify(filtered));
      loadNotifications();
    }
    function toast(message) {
      const el = document.getElementById('toast');
      el.textContent = message;
      el.classList.remove('hidden');
      clearTimeout(el.__t);
      el.__t = setTimeout(() => el.classList.add('hidden'), 4000);
    }
    function ensureNotifyPermission() {
      try {
        if (typeof Notification === 'undefined') return;
        if (Notification.permission === 'default') {
          Notification.requestPermission();
        }
      } catch (_) {}
    }
    function notify(title, body) {
      try {
        if (typeof Notification === 'undefined') return;
        if (Notification.permission === 'granted') {
          new Notification(title, { body });
        } else {
          toast(`${title}: ${body}`);
        }
      } catch (_) {}
    }

    function joinVendorRoom(vendorCode) {
      if (!vendorCode || vendorCode === joinedVendor) return;
      joinedVendor = vendorCode;
      socket.emit('join_vendor', vendorCode);
    }
    function estWait(currentServing, myNumber) {
      if (!currentServing || !myNumber) return '-';
      const delta = Math.max(0, myNumber - currentServing);
      return (delta * 2) + 'm';
    }

    $('getTokenBtn').addEventListener('click', async () => {
      const vendorCode = $('vendorInput').value.trim();
      if (!vendorCode) return alert('Enter vendor code');
      const note = $('noteInput').value.trim();
      const res = await fetch('/token/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vendorCode, note }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      myTokenNumber = data.token.number;
      joinVendorRoom(vendorCode);
      $('userStatus').classList.remove('hidden');
      $('yourToken').textContent = myTokenNumber;
      $('currentServing').textContent = data.vendor.currentServing || '-';
      $('eta').textContent = estWait(data.vendor.currentServing, myTokenNumber);
      
      // Add notification for new token
      const shopName = data.vendor.name || vendorCode;
      addNotifCard('Token Received', `You got token #${myTokenNumber} at ${shopName}.`, true, data.token._id, myTokenNumber, vendorCode);
      
      // Persist for refresh
      localStorage.setItem('user_vendor_code', vendorCode);
      localStorage.setItem('user_token_number', String(myTokenNumber));
      localStorage.setItem('user_token_id', data.token._id || '');
      localStorage.setItem('user_note', note || '');
      loadMyShops();
    });

    socket.on('vendor_update', async (payload) => {
      if (!joinedVendor || payload.vendorCode === joinedVendor) {
        $('currentServing').textContent = payload.currentServing || '-';
        $('eta').textContent = estWait(payload.currentServing, myTokenNumber);
        if (myTokenNumber) {
          // Get vendor name for notifications
          let vendorName = 'Shop';
          try {
            const vendorRes = await fetch(`/token/list?vendorCode=${encodeURIComponent(payload.vendorCode)}`);
            const vendorData = await vendorRes.json();
            if (vendorData.vendor && vendorData.vendor.name) {
              vendorName = vendorData.vendor.name;
            }
          } catch (_) {}
          
          if (payload.currentServing === myTokenNumber) {
            const title = 'Now Serving';
            const body = `Your token ${myTokenNumber} is now being served at ${vendorName}.`;
            addNotifCard(title, body, false, localStorage.getItem('user_token_id'), myTokenNumber, payload.vendorCode); // Non-persistent - will be cleared when order completes
            notify(title, body);
          } else if (payload.nextWaiting === myTokenNumber) {
            const title = 'Next in Queue';
            const body = `Your token ${myTokenNumber} is next in queue at ${vendorName}.`;
            addNotifCard(title, body, true, localStorage.getItem('user_token_id'), myTokenNumber, payload.vendorCode);
            notify(title, body);
          }
        }
      }
      loadMyShops();
    });

    // Multi-shop: render cards and notifications per vendor
    async function loadMyShops() {
      try {
        const [mineAll, hist] = await Promise.all([
          apiJson('/token/mineAll'),
          apiJson('/history/list')
        ]);
        const container = $('shopCards');
        container.innerHTML = '';
        let items = mineAll.items || [];
        if (!items.length) { container.innerHTML = '<div class="text-slate-400">No shops yet.</div>'; return; }
        const historyByTokenId = new Map((hist.records || []).map(r => [String(r.tokenId), r]));
        
        // Check for completed tokens and clear their notifications
        const completedTokens = [];
        items.forEach(it => {
          const rec = it.token?._id ? historyByTokenId.get(String(it.token._id)) : null;
          if (rec && rec.status === 'Completed') {
            completedTokens.push(it.token._id);
          }
        });
        
        // Clear notifications for all completed tokens
        completedTokens.forEach(tokenId => {
          clearNotificationsForToken(tokenId);
        });
        
        // Filter out completed tokens so cards only show active/created ones
        items = items.filter(it => {
          const rec = it.token?._id ? historyByTokenId.get(String(it.token._id)) : null;
          return !(rec && rec.status === 'Completed');
        });
        if (!items.length) { container.innerHTML = '<div class="text-slate-400">No active shops. Completed tokens are in History.</div>'; return; }
        for (const it of items) {
          // join socket room for live updates
          socket.emit('join_vendor', it.vendorCode);
          const rec = it.token?._id ? historyByTokenId.get(String(it.token._id)) : null;
          const statusLabel = rec?.status ? rec.status : (it.token?.status === 'waiting' ? 'Pending' : (it.token?.status === 'served' ? 'Created' : (it.token?.status || '-')));
          const canUserConfirm = !!rec && rec.status !== 'Completed' && !rec.userConfirmed;
          const shopName = it.vendorName || it.vendorCode;
          const tokenNumber = it.token?.number ?? '-';
          
          // Determine if shop name is long and needs special handling
          const isLongName = shopName.length > 15;
          const nameClass = isLongName ? 'token-name long-name' : 'token-name';
          
          // Check if text is truncated (needs clickable functionality)
          const isTruncated = shopName.length > 12;
          
          const card = document.createElement('div');
          card.className = `token-card ${statusLabel.toLowerCase()}${isTruncated ? ' clickable' : ''}`;
          
          // Add animation class for new cards
          setTimeout(() => {
            card.classList.add('animate-in');
          }, 100);
          
          card.innerHTML = `
            <div class="token-header">
              <div class="${nameClass}">${shopName}</div>
              <div class="token-id">#${tokenNumber}</div>
            </div>
            <div class="token-vendor-code">
              <span class="vendor-code-label">Code:</span>
              <span class="vendor-code-value">${it.vendorCode}</span>
            </div>
            <div class="token-status">
              <span class="status-label">Status:</span>
              <span class="status-badge ${statusLabel.toLowerCase()}">${statusLabel}</span>
            </div>
            <div class="token-actions">
              ${canUserConfirm ? `<button class="token-btn confirm shop-confirm" data-id="${it.token?._id || ''}">Confirm</button>` : ''}
            </div>
          `;
          
          container.appendChild(card);
          
          // Add click handler for truncated tokens
          if (isTruncated) {
            card.addEventListener('click', (e) => {
              // Don't trigger if clicking on the confirm button
              if (e.target.closest('.token-btn')) return;
              
              showTokenDetails({
                shopName: shopName,
                tokenNumber: tokenNumber,
                status: statusLabel,
                canConfirm: canUserConfirm,
                tokenId: it.token?._id,
                vendorCode: it.vendorCode
              });
            });
          }
          
          const btn = card.querySelector('button.shop-confirm');
          if (btn && it.token?._id) {
            btn.addEventListener('click', async () => {
              try {
                // Add loading state with animation
                btn.classList.add('loading');
                btn.disabled = true;
                
                await apiJson('/history/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tokenId: it.token._id }) });
                
                // Remove loading state and add success animation
                btn.classList.remove('loading');
                btn.textContent = 'Confirmed!';
                btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                btn.style.color = 'white';
                
                // Add status change animation to the badge
                const statusBadge = card.querySelector('.status-badge');
                if (statusBadge) {
                  statusBadge.classList.add('status-changing');
                  setTimeout(() => {
                    statusBadge.classList.remove('status-changing');
                  }, 600);
                }
                
                // Add notification for successful confirmation
                addNotifCard('Service Confirmed', `Your service at ${shopName} has been confirmed.`, true, it.token._id, it.token.number, it.vendorCode);
                
                // Clear all notifications for this token since it's now completed
                setTimeout(() => {
                  clearNotificationsForToken(it.token._id);
                }, 2000);
                
                // Refresh the shop cards after a short delay
                setTimeout(async () => {
                  await loadMyShops();
                }, 1500);
              } catch (e) { 
                btn.classList.remove('loading');
                btn.textContent = 'Try Again';
                btn.disabled = false;
                alert('Confirm failed'); 
              }
            });
          }
        }
      } catch (_) {}
    }
    // Removed refresh button - shops now auto-update

    async function refreshVendorStatus(vendorCode) {
      try {
        const res = await fetch(`/token/list?vendorCode=${encodeURIComponent(vendorCode)}`);
        const data = await res.json();
        if (data.vendor) {
          $('currentServing').textContent = data.vendor.currentServing ?? '-';
          $('eta').textContent = estWait(data.vendor.currentServing, myTokenNumber);
        }
      } catch (_) {}
    }

    

    // QR scan
    function parseVendorFromString(s) {
      if (!s) return null;
      try { const u = new URL(s); const v = u.searchParams.get('vendor'); if (v) return v; } catch(_){}
      const m = s.trim().match(/^[A-Za-z0-9]{4,10}$/); return m ? m[0].toUpperCase() : null;
    }
    async function startQrScan() {
      const modal = $('qrModal'); const video = $('qrVideo');
      try {
        qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = qrStream; await video.play();
        modal.classList.remove('hidden'); modal.classList.add('flex');
        qrAnimating = true;
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const tick = () => {
          if (!qrAnimating) return;
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const result = jsQR(img.data, canvas.width, canvas.height, { inversionAttempts: 'dontInvert' });
            if (result && result.data) {
              const vendor = parseVendorFromString(result.data);
              if (vendor) { $('vendorInput').value = vendor; stopQrScan(); return; }
            }
          }
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      } catch (e) { alert('Camera error: ' + e.message); stopQrScan(); }
    }
    function stopQrScan() {
      qrAnimating = false; const modal = $('qrModal'); modal.classList.add('hidden'); modal.classList.remove('flex');
      const video = $('qrVideo'); if (qrStream) { qrStream.getTracks().forEach(t => t.stop()); qrStream = null; } video.srcObject = null;
    }
    $('scanQrBtn').addEventListener('click', startQrScan);
    $('qrCloseBtn').addEventListener('click', stopQrScan);

    // Removed explicit enable button per request

    // Profile event handlers
    $('profileBtn').addEventListener('click', () => {
      const dropdown = $('profileDropdown');
      dropdown.classList.toggle('hidden');
    });

    $('editProfileBtn').addEventListener('click', () => {
      // Populate profile modal with current data
      $('profileName').value = currentUser.name || '';
      $('profileEmailInput').value = currentUser.email || '';
      $('profilePhone').value = currentUser.phone || '';
      
      // Show modal
      $('profileModal').classList.remove('hidden');
      $('profileModal').classList.add('flex');
      
      // Close dropdown
      $('profileDropdown').classList.add('hidden');
    });

    $('saveProfileBtn').addEventListener('click', async () => {
      const name = $('profileName').value.trim();
      const email = $('profileEmailInput').value.trim();
      const phone = $('profilePhone').value.trim();
      
      if (!email) {
        toast('Email is required');
        return;
      }
      
      try {
        // Update user profile (you'll need to add this endpoint to server.js)
        const response = await fetch('/auth/updateProfile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone })
        });
        
        if (response.ok) {
          // Update local user data
          currentUser.name = name;
          currentUser.email = email;
          currentUser.phone = phone;
          
          // Update display
          $('profileEmail').textContent = email;
          $('profileInitial').textContent = (name || email).charAt(0).toUpperCase();
          
          // Close modal
          $('profileModal').classList.add('hidden');
          $('profileModal').classList.remove('flex');
          
          toast('Profile updated successfully');
        } else {
          const data = await response.json();
          toast(data.error || 'Failed to update profile');
        }
      } catch (e) {
        toast('Failed to update profile');
      }
    });

    $('cancelProfileBtn').addEventListener('click', () => {
      $('profileModal').classList.add('hidden');
      $('profileModal').classList.remove('flex');
    });

    $('profileCloseBtn').addEventListener('click', () => {
      $('profileModal').classList.add('hidden');
      $('profileModal').classList.remove('flex');
    });

    $('logoutBtn').addEventListener('click', async () => { 
      localStorage.removeItem('user_vendor_code');
      localStorage.removeItem('user_token_number');
      await fetch('/auth/logout', { method: 'POST' }); 
      location.href = '/'; 
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#profileBtn') && !e.target.closest('#profileDropdown')) {
        $('profileDropdown').classList.add('hidden');
      }
    });

    // Ask for notification permission on load
    ensureNotifyPermission();

    // Token Details Modal Functions
    function showTokenDetails(tokenData) {
      const modal = $('tokenDetailsModal');
      const title = $('tokenDetailsTitle');
      const id = $('tokenDetailsId');
      const status = $('tokenDetailsStatus');
      const actions = $('tokenDetailsActions');
      
      // Populate modal content
      title.textContent = tokenData.shopName;
      id.textContent = `#${tokenData.tokenNumber}`;
      status.textContent = tokenData.status;
      status.className = `token-details-status-badge ${tokenData.status.toLowerCase()}`;
      
      // Clear any existing vendor code elements to prevent duplicates
      const existingVendorCodes = modal.querySelectorAll('.token-details-vendor-code');
      existingVendorCodes.forEach(el => el.remove());
      
      // Add vendor code to modal if available
      if (tokenData.vendorCode) {
        const vendorCodeElement = document.createElement('div');
        vendorCodeElement.className = 'token-details-vendor-code';
        vendorCodeElement.innerHTML = `
          <div class="token-details-status-label">Vendor Code:</div>
          <div class="vendor-code-value" style="margin: 0 auto; display: inline-block;">${tokenData.vendorCode}</div>
        `;
        status.parentNode.insertBefore(vendorCodeElement, status.parentNode.lastElementChild);
      }
      
      // Add action button if needed
      if (tokenData.canConfirm && tokenData.tokenId) {
        actions.innerHTML = `
          <button class="token-details-btn" onclick="confirmTokenFromModal('${tokenData.tokenId}', '${tokenData.shopName}')">
            Confirm Service
          </button>
        `;
      } else {
        actions.innerHTML = '';
      }
      
      // Show modal
      modal.classList.add('show');
    }
    
    function hideTokenDetails() {
      const modal = $('tokenDetailsModal');
      modal.classList.remove('show');
    }
    
    async function confirmTokenFromModal(tokenId, shopName) {
      try {
        await apiJson('/history/confirm', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ tokenId: tokenId }) 
        });
        
        // Add notification for successful confirmation
        addNotifCard('Service Confirmed', `Your service at ${shopName} has been confirmed.`, true, tokenId, null, null);
        
        // Hide modal and refresh
        hideTokenDetails();
        await loadMyShops();
        
        toast('Service confirmed successfully!');
      } catch (e) {
        toast('Failed to confirm service');
      }
    }
    
    // Modal event handlers
    $('tokenDetailsClose').addEventListener('click', hideTokenDetails);
    $('tokenDetailsModal').addEventListener('click', (e) => {
      if (e.target === $('tokenDetailsModal')) {
        hideTokenDetails();
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('tokenDetailsModal').classList.contains('show')) {
        hideTokenDetails();
      }
    });

    $('notifClear').addEventListener('click', () => {
      // Clear all notifications from localStorage and UI
      localStorage.removeItem('notifications');
      const list = document.getElementById('notifList');
      list.innerHTML = '<div class="text-slate-400">No notifications yet.</div>';
    });
  </script>
</body>
</html>


