<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MG Virtual Line - User</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link rel="icon" href="data:," />
  <style>.card{box-shadow:0 2px 12px rgba(0,0,0,.08)}</style>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="max-w-5xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between py-4">
      <div>
        <h1 class="text-xl font-bold">MG Virtual Line</h1>
        <p class="text-xs text-slate-400">User</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/history.html" class="text-sm text-slate-300 hover:text-white">History</a>
        <span id="meEmail" class="text-xs text-slate-400"></span>
        <button id="logoutBtn" class="text-sm text-slate-300 hover:text-white">Logout</button>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-slate-300">Vendor Code</label>
          <input id="vendorInput" class="mt-1 w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="e.g. ABC123" />
          <div class="flex items-center gap-2 mt-2">
            <button id="scanQrBtn" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm border border-indigo-500/40">Scan QR</button>
            <p class="text-xs text-slate-400">Auto-filled from QR or link.</p>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300">Optional Request/Note</label>
          <input id="noteInput" class="mt-1 w-full border border-slate-700 bg-slate-900 rounded px-3 py-2" placeholder="Brief note" />
        </div>
        <button id="getTokenBtn" class="w-full py-3 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-lg font-semibold">Get Token</button>
      </div>
      <div id="userStatus" class="mt-4 hidden">
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Your Token</div>
            <div id="yourToken" class="text-2xl font-bold">-</div>
          </div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Serving</div>
            <div id="currentServing" class="text-2xl font-bold">-</div>
          </div>
          <div class="p-3 rounded bg-slate-800 border border-slate-700">
            <div class="text-xs text-slate-400">Est. Wait</div>
            <div id="eta" class="text-2xl font-bold">-</div>
          </div>
        </div>
        
      </div>
    </section>

    <!-- Notifications Panel -->
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Notifications</h3>
        <button id="notifClear" class="text-xs px-2 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-800">Clear</button>
      </div>
      <div id="notifList" class="space-y-2 max-h-56 overflow-auto text-sm">
        <div class="text-slate-400">No notifications yet.</div>
      </div>
    </section>
    </div>

    <!-- Multi-shop cards -->
    <section class="card bg-slate-800 border border-slate-700 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Your Shops</h3><button id="refreshShops" class="text-xs px-2 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-800">Refresh</button></div>
      <div id="shopCards" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
    </section>

    <!-- QR Scanner Modal -->
    <div id="qrModal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4">
      <div class="bg-slate-800 border border-slate-700 rounded-lg w-full max-w-sm p-4 space-y-3 text-slate-100">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Scan QR Code</h3>
          <button id="qrCloseBtn" class="text-slate-400 hover:text-slate-200">Close</button>
        </div>
        <video id="qrVideo" class="w-full rounded border border-slate-700 bg-slate-950" playsinline></video>
        <p class="text-xs text-slate-400">Point your camera at the shop/office QR.</p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden max-w-xs bg-slate-800 border border-slate-700 text-slate-100 text-sm rounded px-3 py-2 shadow"></div>


  <script>
    const $ = (id) => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const vendorFromUrl = params.get('vendor');
    if (vendorFromUrl) $('vendorInput').value = vendorFromUrl;

    async function apiJson(url, options = {}) {
      const res = await fetch(url, options);
      const text = await res.text();
      try { const data = JSON.parse(text); if (!res.ok) throw new Error(data.error || res.statusText); return data; } catch (e) { throw new Error(text); }
    }

    (async () => {
      const me = await apiJson('/auth/me');
      if (!me.user) { location.href = '/'; return; }
      if (me.user.role === 'admin') { location.href = '/admin.html'; return; }
      document.getElementById('meEmail').textContent = me.user.email || '';
      // Prefer server latest token for this user/vendor if provided via URL or storage
      let vendor = vendorFromUrl || localStorage.getItem('user_vendor_code');
      if (vendor) {
        $('vendorInput').value = vendor;
        joinVendorRoom(vendor);
        refreshVendorStatus(vendor);
        try {
          const mine = await apiJson(`/token/mine?vendorCode=${encodeURIComponent(vendor)}`);
          if (mine.token) {
            myTokenNumber = mine.token.number;
            $('userStatus').classList.remove('hidden');
            $('yourToken').textContent = myTokenNumber;
            // restore vendor stats too
            $('currentServing').textContent = mine.vendor?.currentServing ?? '-';
            $('eta').textContent = estWait(mine.vendor?.currentServing, myTokenNumber);
            if (typeof mine.token.note === 'string') $('noteInput').value = mine.token.note;
            localStorage.setItem('user_token_number', String(myTokenNumber));
            localStorage.setItem('user_vendor_code', vendor);
            if (mine.token._id) localStorage.setItem('user_token_id', mine.token._id);
          } else {
            const savedId = localStorage.getItem('user_token_id');
            if (savedId) {
              const t = await apiJson(`/token/get?id=${encodeURIComponent(savedId)}`);
              if (t.token && t.token.vendorCode === vendor) {
                myTokenNumber = t.token.number;
                $('userStatus').classList.remove('hidden');
                $('yourToken').textContent = myTokenNumber;
                $('currentServing').textContent = t.vendor?.currentServing ?? '-';
                $('eta').textContent = estWait(t.vendor?.currentServing, myTokenNumber);
                if (typeof t.token.note === 'string') $('noteInput').value = t.token.note;
              }
            }
          }
        } catch (_) {}
      } else {
        // fallback to local only
        const savedVendor = localStorage.getItem('user_vendor_code');
        const savedToken = localStorage.getItem('user_token_number');
        const savedNote = localStorage.getItem('user_note');
        if (savedVendor) {
          $('vendorInput').value = savedVendor;
          joinVendorRoom(savedVendor);
          refreshVendorStatus(savedVendor);
        }
        if (savedToken) {
          document.getElementById('userStatus').classList.remove('hidden');
          document.getElementById('yourToken').textContent = savedToken;
          myTokenNumber = parseInt(savedToken, 10);
        }
        if (savedNote) $('noteInput').value = savedNote;
      }
    })();

    const socket = io();
    let joinedVendor = null;
    let myTokenNumber = null;
    let qrStream = null;
    let qrAnimating = false;

    // Notifications
    function addNotifCard(title, body) {
      const list = document.getElementById('notifList');
      const ts = new Date();
      const time = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const card = document.createElement('div');
      card.className = 'rounded border border-slate-700 p-2 bg-slate-900';
      card.innerHTML = `<div class="flex items-center justify-between"><div class="font-medium">${title}</div><div class="text-xs text-slate-400">${time}</div></div><div class="text-slate-300 text-sm mt-1">${body}</div>`;
      if (list.firstElementChild && list.firstElementChild.classList.contains('text-slate-400')) {
        list.innerHTML = '';
      }
      list.prepend(card);
    }
    function toast(message) {
      const el = document.getElementById('toast');
      el.textContent = message;
      el.classList.remove('hidden');
      clearTimeout(el.__t);
      el.__t = setTimeout(() => el.classList.add('hidden'), 4000);
    }
    function ensureNotifyPermission() {
      try {
        if (typeof Notification === 'undefined') return;
        if (Notification.permission === 'default') {
          Notification.requestPermission();
        }
      } catch (_) {}
    }
    function notify(title, body) {
      try {
        if (typeof Notification === 'undefined') return;
        if (Notification.permission === 'granted') {
          new Notification(title, { body });
        } else {
          toast(`${title}: ${body}`);
        }
      } catch (_) {}
    }

    function joinVendorRoom(vendorCode) {
      if (!vendorCode || vendorCode === joinedVendor) return;
      joinedVendor = vendorCode;
      socket.emit('join_vendor', vendorCode);
    }
    function estWait(currentServing, myNumber) {
      if (!currentServing || !myNumber) return '-';
      const delta = Math.max(0, myNumber - currentServing);
      return (delta * 2) + 'm';
    }

    $('getTokenBtn').addEventListener('click', async () => {
      const vendorCode = $('vendorInput').value.trim();
      if (!vendorCode) return alert('Enter vendor code');
      const note = $('noteInput').value.trim();
      const res = await fetch('/token/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vendorCode, note }) });
      const data = await res.json();
      if (data.error) return alert(data.error);
      myTokenNumber = data.token.number;
      joinVendorRoom(vendorCode);
      $('userStatus').classList.remove('hidden');
      $('yourToken').textContent = myTokenNumber;
      $('currentServing').textContent = data.vendor.currentServing || '-';
      $('eta').textContent = estWait(data.vendor.currentServing, myTokenNumber);
      // Persist for refresh
      localStorage.setItem('user_vendor_code', vendorCode);
      localStorage.setItem('user_token_number', String(myTokenNumber));
      localStorage.setItem('user_token_id', data.token._id || '');
      localStorage.setItem('user_note', note || '');
      loadMyShops();
    });

    socket.on('vendor_update', (payload) => {
      if (!joinedVendor || payload.vendorCode === joinedVendor) {
        $('currentServing').textContent = payload.currentServing || '-';
        $('eta').textContent = estWait(payload.currentServing, myTokenNumber);
        if (myTokenNumber) {
          if (payload.currentServing === myTokenNumber) {
            const title = 'Now Serving';
            const body = `Your token ${myTokenNumber} is now being served.`;
            addNotifCard(title, body);
            notify(title, body);
          } else if (payload.nextWaiting === myTokenNumber) {
            const title = 'Next in Queue';
            const body = `Your token ${myTokenNumber} is next in queue.`;
            addNotifCard(title, body);
            notify(title, body);
          }
        }
      }
      loadMyShops();
    });

    // Multi-shop: render cards and notifications per vendor
    async function loadMyShops() {
      try {
        const [mineAll, hist] = await Promise.all([
          apiJson('/token/mineAll'),
          apiJson('/history/list')
        ]);
        const container = $('shopCards');
        container.innerHTML = '';
        let items = mineAll.items || [];
        if (!items.length) { container.innerHTML = '<div class="text-slate-400">No shops yet.</div>'; return; }
        const historyByTokenId = new Map((hist.records || []).map(r => [String(r.tokenId), r]));
        // Filter out completed tokens so cards only show active/created ones
        items = items.filter(it => {
          const rec = it.token?._id ? historyByTokenId.get(String(it.token._id)) : null;
          return !(rec && rec.status === 'Completed');
        });
        if (!items.length) { container.innerHTML = '<div class="text-slate-400">No active shops. Completed tokens are in History.</div>'; return; }
        for (const it of items) {
          // join socket room for live updates
          socket.emit('join_vendor', it.vendorCode);
          const rec = it.token?._id ? historyByTokenId.get(String(it.token._id)) : null;
          const statusLabel = rec?.status ? rec.status : (it.token?.status === 'waiting' ? 'Pending' : (it.token?.status === 'served' ? 'Created' : (it.token?.status || '-')));
          const badge = statusLabel==='Created'?'bg-amber-600':(statusLabel==='Pending'?'bg-slate-600':'bg-emerald-600');
          const canUserConfirm = !!rec && rec.status !== 'Completed' && !rec.userConfirmed;
          const card = document.createElement('div');
          card.className = 'rounded border border-slate-700 p-3 bg-slate-900';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">${it.vendorName || it.vendorCode}</div>
              <div class="text-xs text-slate-400">#${it.token?.number ?? '-'}</div>
            </div>
            <div class="text-sm mt-1">Status: <span class="px-2 py-0.5 rounded text-xs ${badge}">${statusLabel}</span></div>
            <div class="mt-2">
              ${canUserConfirm ? `<button class=\"shop-confirm text-xs px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white\" data-id=\"${it.token?._id || ''}\">Confirm</button>` : ''}
            </div>
          `;
          container.appendChild(card);
          const btn = card.querySelector('button.shop-confirm');
          if (btn && it.token?._id) {
            btn.addEventListener('click', async () => {
              try {
                await apiJson('/history/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tokenId: it.token._id }) });
                await loadMyShops();
              } catch (e) { alert('Confirm failed'); }
            });
          }
        }
      } catch (_) {}
    }
    $('refreshShops').addEventListener('click', loadMyShops);

    async function refreshVendorStatus(vendorCode) {
      try {
        const res = await fetch(`/token/list?vendorCode=${encodeURIComponent(vendorCode)}`);
        const data = await res.json();
        if (data.vendor) {
          $('currentServing').textContent = data.vendor.currentServing ?? '-';
          $('eta').textContent = estWait(data.vendor.currentServing, myTokenNumber);
        }
      } catch (_) {}
    }

    

    // QR scan
    function parseVendorFromString(s) {
      if (!s) return null;
      try { const u = new URL(s); const v = u.searchParams.get('vendor'); if (v) return v; } catch(_){}
      const m = s.trim().match(/^[A-Za-z0-9]{4,10}$/); return m ? m[0].toUpperCase() : null;
    }
    async function startQrScan() {
      const modal = $('qrModal'); const video = $('qrVideo');
      try {
        qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = qrStream; await video.play();
        modal.classList.remove('hidden'); modal.classList.add('flex');
        qrAnimating = true;
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const tick = () => {
          if (!qrAnimating) return;
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const result = jsQR(img.data, canvas.width, canvas.height, { inversionAttempts: 'dontInvert' });
            if (result && result.data) {
              const vendor = parseVendorFromString(result.data);
              if (vendor) { $('vendorInput').value = vendor; stopQrScan(); return; }
            }
          }
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      } catch (e) { alert('Camera error: ' + e.message); stopQrScan(); }
    }
    function stopQrScan() {
      qrAnimating = false; const modal = $('qrModal'); modal.classList.add('hidden'); modal.classList.remove('flex');
      const video = $('qrVideo'); if (qrStream) { qrStream.getTracks().forEach(t => t.stop()); qrStream = null; } video.srcObject = null;
    }
    $('scanQrBtn').addEventListener('click', startQrScan);
    $('qrCloseBtn').addEventListener('click', stopQrScan);

    // Removed explicit enable button per request

    $('logoutBtn').addEventListener('click', async () => { 
      localStorage.removeItem('user_vendor_code');
      localStorage.removeItem('user_token_number');
      await fetch('/auth/logout', { method: 'POST' }); 
      location.href = '/'; 
    });

    // Ask for notification permission on load
    ensureNotifyPermission();

    // Removed banner helpers per request

    document.getElementById('notifClear').addEventListener('click', () => {
      const list = document.getElementById('notifList');
      list.innerHTML = '<div class="text-slate-400">No notifications yet.</div>';
    });
  </script>
</body>
</html>


